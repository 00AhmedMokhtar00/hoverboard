<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">

<script>
  (function () {
    'use strict';

    HOVERBOARD.AppLocalizeBehaviorImpl = {

      properties: {
        app: {
          type: Object,
          notify: true
        },

        loadExternalResources: {
          type: Boolean,
          value: true
        },

        /* Overriden from Polymer.AppLocalizeBehavior */
        formats: {
          type: Object,
          value: function () {
            return {
              number: {USD: {style: 'currency', currency: 'USD'}}
            };
          }
        },

        /* Overriden from Polymer.AppLocalizeBehavior */
        language: {
          type: String,
          value: function () {
            var lang = window.navigator.languages ? window.navigator.languages[0] : null;
            lang = lang || window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage;
            if (lang.indexOf('-') !== -1)
              lang = lang.split('-')[0];
            if (lang.indexOf('_') !== -1)
              lang = lang.split('_')[0];
            return lang;
          }
        }
      },

      listeners: {
        'app-resources-loaded': '_onLocalesLoaded'
      },

      attached: function () {
        this.loadElementResources(this.tagName);
      },

      observers: [
        'linkResources(app.resources)'
      ],

      loadElementResources: function (element) {
        if (this.loadExternalResources) {
          var url = '/data/resources/' + element.toLowerCase() + '.json';
          this.loadResources(this.resolveUrl(url));
        }
      },

      linkResources: function () {
        if (!this.loadExternalResources && this.app.resources) {
          this.resources = this.app.resources;
          this.fire('app-resources-loaded');
        }
      },

      __onRequestResponse: function (event) {
        if (!event.response || !this.app) return;
        var resources = event.response.resources;
        var data = event.response.data;
        if (resources) {
          var appResources = this.app.resources || {};
          for (var lang in resources) {
            if (resources.hasOwnProperty(lang)) {
              appResources[lang] = HOVERBOARD.Util.extend(appResources[lang], resources[lang]);
            }
          }
          this.set('app.resources', appResources);
        }
        if (data) {
          this.app.data = this.app.data || {};
          for (var val in data) {
            if (data.hasOwnProperty(val)) {
              this.set('app.data.' + val, data[val]);
            }
          }
        }
        this.resources = this.app.resources;
        this.fire('app-resources-loaded');
      },

      _onLocalesLoaded: function (event) {
        event.stopPropagation();
      }

    };

  }());
</script>
