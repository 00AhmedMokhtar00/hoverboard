<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">

<script>
  (function () {
    'use strict';

    HOVERBOARD.AppLocalizeBehaviorImpl = {

      properties: {
        app: {
          type: Object,
          notify: true
        },

        loadExternalResources: {
          type: Boolean,
          value: true
        }
      },

      listeners: {
        'app-resources-loaded': '_onLocalesLoaded'
      },

      attached: function () {
        this.loadElementResources(this.tagName);
      },

      observers: [
        'linkResources(app.resources)',
        'setLanguage(app.lang)'
      ],

      loadElementResources: function (element) {
        if (this.loadExternalResources) {
          var url = '/data/resources/' + element.toLowerCase() + '.json';
          this.loadResources(this.resolveUrl(url));
        }
      },

      linkResources: function () {
        if (!this.loadExternalResources && this.app.resources) {
          this.resources = this.app.resources;
          this.fire('app-resources-loaded');
        }
      },

      setLanguage: function (lang) {
        if (lang)
        this.set('language', lang);
      },

      __onRequestResponse: function (event) {
        if (!event.response || !this.app) return;
        var resources = event.response.resources;
        var data = event.response.data;
        if (resources) {
          var appResources = this.app.resources || {};
          for (var lang in resources) {
            if (resources.hasOwnProperty(lang)) {
              appResources[lang] = HOVERBOARD.Util.extend(appResources[lang], resources[lang]);
            }
          }
          this.set('app.resources', appResources);
        }
        if (data) {
          this.app.data = this.app.data || {};
          for (var val in data) {
            if (data.hasOwnProperty(val)) {
              this.set('app.data.' + val, data[val]);
            }
          }
        }
        this.resources = this.app.resources;
        this.fire('app-resources-loaded');
      },

      _onLocalesLoaded: function (event) {
        event.stopPropagation();
      }

    };

    HOVERBOARD.AppLocalizeBehavior = [
      Polymer.AppLocalizeBehavior,
      HOVERBOARD.AppLocalizeBehaviorImpl
    ];

  }());
</script>
